import { provideHttpClient } from '@angular/common/http';
import { TestBed } from '@angular/core/testing';
import { NamedLoggingServiceFactory } from '@neuroglia/angular-logging';
import { HttpErrorObserverService, ODataQueryResultDto, UrlHelperService } from '@neuroglia/angular-rest-core';
import { GraphQLDataSource } from './graphql-data-source';
import {
  GRAPHQL_DATA_SOURCE_ENDPOINT,
  GRAPHQL_DATA_SOURCE_FIELDS,
  GRAPHQL_DATA_SOURCE_QUERY_BUILDER,
  GRAPHQL_DATA_SOURCE_TARGET,
} from './injection-tokens';
import { combineLatest, filter, take, tap, timer } from 'rxjs';
import {
  CombinedParams,
  QUERYABLE_DATA_SOURCE_COUNT_SELECTOR,
  QUERYABLE_DATA_SOURCE_DATA_SELECTOR,
} from '@neuroglia/angular-data-source-queryable';
import { GraphQLQueryArguments, GraphQLQueryBuilder, GraphQLVariablesMapper } from './models';

const testEndpoint = 'https://swapi-graphql.netlify.app/.netlify/functions/index';

const target = 'allPlanets';

const defaultFields = [
  'name',
  'climates',
  'created',
  'diameter',
  'edited',
  'gravity',
  'id',
  'orbitalPeriod',
  'population',
  'rotationPeriod',
  'surfaceWater',
  'terrains',
];

const queryBuilder: GraphQLQueryBuilder = (
  target: string,
  args: GraphQLQueryArguments | null,
  fields: string[],
  combinedParams: CombinedParams<any>,
): string => {
  const operationName = 'QueryStarWars';
  const [selectParam, expandParam, pagingParam, orderByParam, searchParam, transformParam, filterParam] =
    combinedParams;
  const select = selectParam?.select;
  const expand = expandParam?.expand;
  let selectAndExpand: string[] = [];
  if (select) {
    if (!Array.isArray(select)) {
      selectAndExpand.push(select as string);
    } else if (select.length) {
      selectAndExpand = [...selectAndExpand, ...(select as string[])];
    }
  }
  if (expand) {
    if (!Array.isArray(expand)) {
      selectAndExpand.push(expand as string);
    } else if (expand.length) {
      selectAndExpand = [...selectAndExpand, ...(expand as string[])];
    }
  }
  const processedFields = (!selectAndExpand.length ? fields : selectAndExpand).join('\n');
  let operationArgs = '';
  let targetArgs = '';
  if (args && Object.keys(args).length) {
    operationArgs = `(${Object.entries(args).reduce(
      (acc, [name, type], idx) => acc + `${idx !== 0 ? ',' : ''}$${name}: ${type}`,
      '',
    )})`;
    targetArgs = `(${Object.keys(args).reduce(
      (acc, name, idx) => acc + `${idx !== 0 ? ',' : ''}${name}: $${name}`,
      '',
    )})`;
  }
  const query = `query ${operationName} ${operationArgs} {
    ${target} ${targetArgs} {
      totalCount
      pageInfo {
        startCursor
        endCursor
        hasNextPage
        hasPreviousPage
      }
      planets {
        ${processedFields}
      }
    }
  }
  `;
  const variables: any = {};
  if (pagingParam?.top) {
    variables.first = pagingParam.top;
    if (pagingParam.skip) {
      variables.after = btoa(`arrayconnection:${pagingParam.skip - 1}`);
    }
  }
  return JSON.stringify({ operationName, query, variables });
};

const countSelector = (graphqlResponse: any): number => graphqlResponse?.data?.allPlanets?.totalCount || 0;

const dataSelector = (graphqlResponse: any): any[] => graphqlResponse?.data?.allPlanets?.planets || [];

const responseMapper = (graphqlResponse: any): ODataQueryResultDto<any> => ({
  '@odata.context': 'unkown',
  '@odata.count': countSelector(graphqlResponse),
  value: dataSelector(graphqlResponse),
});

const expectedPlanetsResponse = {
  data: {
    allPlanets: {
      pageInfo: {
        startCursor: 'YXJyYXljb25uZWN0aW9uOjA=',
        endCursor: 'YXJyYXljb25uZWN0aW9uOjU5',
        hasNextPage: false,
        hasPreviousPage: false,
      },
      planets: [
        {
          name: 'Tatooine',
          climates: ['arid'],
          created: '2014-12-09T13:50:49.641000Z',
          diameter: 10465,
          edited: '2014-12-20T20:58:18.411000Z',
          gravity: '1 standard',
          id: 'cGxhbmV0czox',
          orbitalPeriod: 304,
          population: 200000,
          rotationPeriod: 23,
          surfaceWater: 1,
          terrains: ['desert'],
        },
        {
          name: 'Alderaan',
          climates: ['temperate'],
          created: '2014-12-10T11:35:48.479000Z',
          diameter: 12500,
          edited: '2014-12-20T20:58:18.420000Z',
          gravity: '1 standard',
          id: 'cGxhbmV0czoy',
          orbitalPeriod: 364,
          population: 2000000000,
          rotationPeriod: 24,
          surfaceWater: 40,
          terrains: ['grasslands', 'mountains'],
        },
        {
          name: 'Yavin IV',
          climates: ['temperate', 'tropical'],
          created: '2014-12-10T11:37:19.144000Z',
          diameter: 10200,
          edited: '2014-12-20T20:58:18.421000Z',
          gravity: '1 standard',
          id: 'cGxhbmV0czoz',
          orbitalPeriod: 4818,
          population: 1000,
          rotationPeriod: 24,
          surfaceWater: 8,
          terrains: ['jungle', 'rainforests'],
        },
        {
          name: 'Hoth',
          climates: ['frozen'],
          created: '2014-12-10T11:39:13.934000Z',
          diameter: 7200,
          edited: '2014-12-20T20:58:18.423000Z',
          gravity: '1.1 standard',
          id: 'cGxhbmV0czo0',
          orbitalPeriod: 549,
          population: null,
          rotationPeriod: 23,
          surfaceWater: 100,
          terrains: ['tundra', 'ice caves', 'mountain ranges'],
        },
        {
          name: 'Dagobah',
          climates: ['murky'],
          created: '2014-12-10T11:42:22.590000Z',
          diameter: 8900,
          edited: '2014-12-20T20:58:18.425000Z',
          gravity: 'N/A',
          id: 'cGxhbmV0czo1',
          orbitalPeriod: 341,
          population: null,
          rotationPeriod: 23,
          surfaceWater: 8,
          terrains: ['swamp', 'jungles'],
        },
        {
          name: 'Bespin',
          climates: ['temperate'],
          created: '2014-12-10T11:43:55.240000Z',
          diameter: 118000,
          edited: '2014-12-20T20:58:18.427000Z',
          gravity: '1.5 (surface), 1 standard (Cloud City)',
          id: 'cGxhbmV0czo2',
          orbitalPeriod: 5110,
          population: 6000000,
          rotationPeriod: 12,
          surfaceWater: 0,
          terrains: ['gas giant'],
        },
        {
          name: 'Endor',
          climates: ['temperate'],
          created: '2014-12-10T11:50:29.349000Z',
          diameter: 4900,
          edited: '2014-12-20T20:58:18.429000Z',
          gravity: '0.85 standard',
          id: 'cGxhbmV0czo3',
          orbitalPeriod: 402,
          population: 30000000,
          rotationPeriod: 18,
          surfaceWater: 8,
          terrains: ['forests', 'mountains', 'lakes'],
        },
        {
          name: 'Naboo',
          climates: ['temperate'],
          created: '2014-12-10T11:52:31.066000Z',
          diameter: 12120,
          edited: '2014-12-20T20:58:18.430000Z',
          gravity: '1 standard',
          id: 'cGxhbmV0czo4',
          orbitalPeriod: 312,
          population: 4500000000,
          rotationPeriod: 26,
          surfaceWater: 12,
          terrains: ['grassy hills', 'swamps', 'forests', 'mountains'],
        },
        {
          name: 'Coruscant',
          climates: ['temperate'],
          created: '2014-12-10T11:54:13.921000Z',
          diameter: 12240,
          edited: '2014-12-20T20:58:18.432000Z',
          gravity: '1 standard',
          id: 'cGxhbmV0czo5',
          orbitalPeriod: 368,
          population: 1000000000000,
          rotationPeriod: 24,
          surfaceWater: null,
          terrains: ['cityscape', 'mountains'],
        },
        {
          name: 'Kamino',
          climates: ['temperate'],
          created: '2014-12-10T12:45:06.577000Z',
          diameter: 19720,
          edited: '2014-12-20T20:58:18.434000Z',
          gravity: '1 standard',
          id: 'cGxhbmV0czoxMA==',
          orbitalPeriod: 463,
          population: 1000000000,
          rotationPeriod: 27,
          surfaceWater: 100,
          terrains: ['ocean'],
        },
        {
          name: 'Geonosis',
          climates: ['temperate', 'arid'],
          created: '2014-12-10T12:47:22.350000Z',
          diameter: 11370,
          edited: '2014-12-20T20:58:18.437000Z',
          gravity: '0.9 standard',
          id: 'cGxhbmV0czoxMQ==',
          orbitalPeriod: 256,
          population: 100000000000,
          rotationPeriod: 30,
          surfaceWater: 5,
          terrains: ['rock', 'desert', 'mountain', 'barren'],
        },
        {
          name: 'Utapau',
          climates: ['temperate', 'arid', 'windy'],
          created: '2014-12-10T12:49:01.491000Z',
          diameter: 12900,
          edited: '2014-12-20T20:58:18.439000Z',
          gravity: '1 standard',
          id: 'cGxhbmV0czoxMg==',
          orbitalPeriod: 351,
          population: 95000000,
          rotationPeriod: 27,
          surfaceWater: 0.9,
          terrains: ['scrublands', 'savanna', 'canyons', 'sinkholes'],
        },
        {
          name: 'Mustafar',
          climates: ['hot'],
          created: '2014-12-10T12:50:16.526000Z',
          diameter: 4200,
          edited: '2014-12-20T20:58:18.440000Z',
          gravity: '1 standard',
          id: 'cGxhbmV0czoxMw==',
          orbitalPeriod: 412,
          population: 20000,
          rotationPeriod: 36,
          surfaceWater: 0,
          terrains: ['volcanoes', 'lava rivers', 'mountains', 'caves'],
        },
        {
          name: 'Kashyyyk',
          climates: ['tropical'],
          created: '2014-12-10T13:32:00.124000Z',
          diameter: 12765,
          edited: '2014-12-20T20:58:18.442000Z',
          gravity: '1 standard',
          id: 'cGxhbmV0czoxNA==',
          orbitalPeriod: 381,
          population: 45000000,
          rotationPeriod: 26,
          surfaceWater: 60,
          terrains: ['jungle', 'forests', 'lakes', 'rivers'],
        },
        {
          name: 'Polis Massa',
          climates: ['artificial temperate'],
          created: '2014-12-10T13:33:46.405000Z',
          diameter: 0,
          edited: '2014-12-20T20:58:18.444000Z',
          gravity: '0.56 standard',
          id: 'cGxhbmV0czoxNQ==',
          orbitalPeriod: 590,
          population: 1000000,
          rotationPeriod: 24,
          surfaceWater: 0,
          terrains: ['airless asteroid'],
        },
        {
          name: 'Mygeeto',
          climates: ['frigid'],
          created: '2014-12-10T13:43:39.139000Z',
          diameter: 10088,
          edited: '2014-12-20T20:58:18.446000Z',
          gravity: '1 standard',
          id: 'cGxhbmV0czoxNg==',
          orbitalPeriod: 167,
          population: 19000000,
          rotationPeriod: 12,
          surfaceWater: null,
          terrains: ['glaciers', 'mountains', 'ice canyons'],
        },
        {
          name: 'Felucia',
          climates: ['hot', 'humid'],
          created: '2014-12-10T13:44:50.397000Z',
          diameter: 9100,
          edited: '2014-12-20T20:58:18.447000Z',
          gravity: '0.75 standard',
          id: 'cGxhbmV0czoxNw==',
          orbitalPeriod: 231,
          population: 8500000,
          rotationPeriod: 34,
          surfaceWater: null,
          terrains: ['fungus forests'],
        },
        {
          name: 'Cato Neimoidia',
          climates: ['temperate', 'moist'],
          created: '2014-12-10T13:46:28.704000Z',
          diameter: 0,
          edited: '2014-12-20T20:58:18.449000Z',
          gravity: '1 standard',
          id: 'cGxhbmV0czoxOA==',
          orbitalPeriod: 278,
          population: 10000000,
          rotationPeriod: 25,
          surfaceWater: null,
          terrains: ['mountains', 'fields', 'forests', 'rock arches'],
        },
        {
          name: 'Saleucami',
          climates: ['hot'],
          created: '2014-12-10T13:47:46.874000Z',
          diameter: 14920,
          edited: '2014-12-20T20:58:18.450000Z',
          gravity: 'unknown',
          id: 'cGxhbmV0czoxOQ==',
          orbitalPeriod: 392,
          population: 1400000000,
          rotationPeriod: 26,
          surfaceWater: null,
          terrains: ['caves', 'desert', 'mountains', 'volcanoes'],
        },
        {
          name: 'Stewjon',
          climates: ['temperate'],
          created: '2014-12-10T16:16:26.566000Z',
          diameter: 0,
          edited: '2014-12-20T20:58:18.452000Z',
          gravity: '1 standard',
          id: 'cGxhbmV0czoyMA==',
          orbitalPeriod: null,
          population: null,
          rotationPeriod: null,
          surfaceWater: null,
          terrains: ['grass'],
        },
        {
          name: 'Eriadu',
          climates: ['polluted'],
          created: '2014-12-10T16:26:54.384000Z',
          diameter: 13490,
          edited: '2014-12-20T20:58:18.454000Z',
          gravity: '1 standard',
          id: 'cGxhbmV0czoyMQ==',
          orbitalPeriod: 360,
          population: 22000000000,
          rotationPeriod: 24,
          surfaceWater: null,
          terrains: ['cityscape'],
        },
        {
          name: 'Corellia',
          climates: ['temperate'],
          created: '2014-12-10T16:49:12.453000Z',
          diameter: 11000,
          edited: '2014-12-20T20:58:18.456000Z',
          gravity: '1 standard',
          id: 'cGxhbmV0czoyMg==',
          orbitalPeriod: 329,
          population: 3000000000,
          rotationPeriod: 25,
          surfaceWater: 70,
          terrains: ['plains', 'urban', 'hills', 'forests'],
        },
        {
          name: 'Rodia',
          climates: ['hot'],
          created: '2014-12-10T17:03:28.110000Z',
          diameter: 7549,
          edited: '2014-12-20T20:58:18.458000Z',
          gravity: '1 standard',
          id: 'cGxhbmV0czoyMw==',
          orbitalPeriod: 305,
          population: 1300000000,
          rotationPeriod: 29,
          surfaceWater: 60,
          terrains: ['jungles', 'oceans', 'urban', 'swamps'],
        },
        {
          name: 'Nal Hutta',
          climates: ['temperate'],
          created: '2014-12-10T17:11:29.452000Z',
          diameter: 12150,
          edited: '2014-12-20T20:58:18.460000Z',
          gravity: '1 standard',
          id: 'cGxhbmV0czoyNA==',
          orbitalPeriod: 413,
          population: 7000000000,
          rotationPeriod: 87,
          surfaceWater: null,
          terrains: ['urban', 'oceans', 'swamps', 'bogs'],
        },
        {
          name: 'Dantooine',
          climates: ['temperate'],
          created: '2014-12-10T17:23:29.896000Z',
          diameter: 9830,
          edited: '2014-12-20T20:58:18.461000Z',
          gravity: '1 standard',
          id: 'cGxhbmV0czoyNQ==',
          orbitalPeriod: 378,
          population: 1000,
          rotationPeriod: 25,
          surfaceWater: null,
          terrains: ['oceans', 'savannas', 'mountains', 'grasslands'],
        },
        {
          name: 'Bestine IV',
          climates: ['temperate'],
          created: '2014-12-12T11:16:55.078000Z',
          diameter: 6400,
          edited: '2014-12-20T20:58:18.463000Z',
          gravity: 'unknown',
          id: 'cGxhbmV0czoyNg==',
          orbitalPeriod: 680,
          population: 62000000,
          rotationPeriod: 26,
          surfaceWater: 98,
          terrains: ['rocky islands', 'oceans'],
        },
        {
          name: 'Ord Mantell',
          climates: ['temperate'],
          created: '2014-12-15T12:23:41.661000Z',
          diameter: 14050,
          edited: '2014-12-20T20:58:18.464000Z',
          gravity: '1 standard',
          id: 'cGxhbmV0czoyNw==',
          orbitalPeriod: 334,
          population: 4000000000,
          rotationPeriod: 26,
          surfaceWater: 10,
          terrains: ['plains', 'seas', 'mesas'],
        },
        {
          name: 'unknown',
          climates: ['unknown'],
          created: '2014-12-15T12:25:59.569000Z',
          diameter: 0,
          edited: '2014-12-20T20:58:18.466000Z',
          gravity: 'unknown',
          id: 'cGxhbmV0czoyOA==',
          orbitalPeriod: 0,
          population: null,
          rotationPeriod: 0,
          surfaceWater: null,
          terrains: ['unknown'],
        },
        {
          name: 'Trandosha',
          climates: ['arid'],
          created: '2014-12-15T12:53:47.695000Z',
          diameter: 0,
          edited: '2014-12-20T20:58:18.468000Z',
          gravity: '0.62 standard',
          id: 'cGxhbmV0czoyOQ==',
          orbitalPeriod: 371,
          population: 42000000,
          rotationPeriod: 25,
          surfaceWater: null,
          terrains: ['mountains', 'seas', 'grasslands', 'deserts'],
        },
        {
          name: 'Socorro',
          climates: ['arid'],
          created: '2014-12-15T12:56:31.121000Z',
          diameter: 0,
          edited: '2014-12-20T20:58:18.469000Z',
          gravity: '1 standard',
          id: 'cGxhbmV0czozMA==',
          orbitalPeriod: 326,
          population: 300000000,
          rotationPeriod: 20,
          surfaceWater: null,
          terrains: ['deserts', 'mountains'],
        },
        {
          name: 'Mon Cala',
          climates: ['temperate'],
          created: '2014-12-18T11:07:01.792000Z',
          diameter: 11030,
          edited: '2014-12-20T20:58:18.471000Z',
          gravity: '1',
          id: 'cGxhbmV0czozMQ==',
          orbitalPeriod: 398,
          population: 27000000000,
          rotationPeriod: 21,
          surfaceWater: 100,
          terrains: ['oceans', 'reefs', 'islands'],
        },
        {
          name: 'Chandrila',
          climates: ['temperate'],
          created: '2014-12-18T11:11:51.872000Z',
          diameter: 13500,
          edited: '2014-12-20T20:58:18.472000Z',
          gravity: '1',
          id: 'cGxhbmV0czozMg==',
          orbitalPeriod: 368,
          population: 1200000000,
          rotationPeriod: 20,
          surfaceWater: 40,
          terrains: ['plains', 'forests'],
        },
        {
          name: 'Sullust',
          climates: ['superheated'],
          created: '2014-12-18T11:25:40.243000Z',
          diameter: 12780,
          edited: '2014-12-20T20:58:18.474000Z',
          gravity: '1',
          id: 'cGxhbmV0czozMw==',
          orbitalPeriod: 263,
          population: 18500000000,
          rotationPeriod: 20,
          surfaceWater: 5,
          terrains: ['mountains', 'volcanoes', 'rocky deserts'],
        },
        {
          name: 'Toydaria',
          climates: ['temperate'],
          created: '2014-12-19T17:47:54.403000Z',
          diameter: 7900,
          edited: '2014-12-20T20:58:18.476000Z',
          gravity: '1',
          id: 'cGxhbmV0czozNA==',
          orbitalPeriod: 184,
          population: 11000000,
          rotationPeriod: 21,
          surfaceWater: null,
          terrains: ['swamps', 'lakes'],
        },
        {
          name: 'Malastare',
          climates: ['arid', 'temperate', 'tropical'],
          created: '2014-12-19T17:52:13.106000Z',
          diameter: 18880,
          edited: '2014-12-20T20:58:18.478000Z',
          gravity: '1.56',
          id: 'cGxhbmV0czozNQ==',
          orbitalPeriod: 201,
          population: 2000000000,
          rotationPeriod: 26,
          surfaceWater: null,
          terrains: ['swamps', 'deserts', 'jungles', 'mountains'],
        },
        {
          name: 'Dathomir',
          climates: ['temperate'],
          created: '2014-12-19T18:00:40.142000Z',
          diameter: 10480,
          edited: '2014-12-20T20:58:18.480000Z',
          gravity: '0.9',
          id: 'cGxhbmV0czozNg==',
          orbitalPeriod: 491,
          population: 5200,
          rotationPeriod: 24,
          surfaceWater: null,
          terrains: ['forests', 'deserts', 'savannas'],
        },
        {
          name: 'Ryloth',
          climates: ['temperate', 'arid', 'subartic'],
          created: '2014-12-20T09:46:25.740000Z',
          diameter: 10600,
          edited: '2014-12-20T20:58:18.481000Z',
          gravity: '1',
          id: 'cGxhbmV0czozNw==',
          orbitalPeriod: 305,
          population: 1500000000,
          rotationPeriod: 30,
          surfaceWater: 5,
          terrains: ['mountains', 'valleys', 'deserts', 'tundra'],
        },
        {
          name: 'Aleen Minor',
          climates: ['unknown'],
          created: '2014-12-20T09:52:23.452000Z',
          diameter: null,
          edited: '2014-12-20T20:58:18.483000Z',
          gravity: 'unknown',
          id: 'cGxhbmV0czozOA==',
          orbitalPeriod: null,
          population: null,
          rotationPeriod: null,
          surfaceWater: null,
          terrains: ['unknown'],
        },
        {
          name: 'Vulpter',
          climates: ['temperate', 'artic'],
          created: '2014-12-20T09:56:58.874000Z',
          diameter: 14900,
          edited: '2014-12-20T20:58:18.485000Z',
          gravity: '1',
          id: 'cGxhbmV0czozOQ==',
          orbitalPeriod: 391,
          population: 421000000,
          rotationPeriod: 22,
          surfaceWater: null,
          terrains: ['urban', 'barren'],
        },
        {
          name: 'Troiken',
          climates: ['unknown'],
          created: '2014-12-20T10:01:37.395000Z',
          diameter: null,
          edited: '2014-12-20T20:58:18.487000Z',
          gravity: 'unknown',
          id: 'cGxhbmV0czo0MA==',
          orbitalPeriod: null,
          population: null,
          rotationPeriod: null,
          surfaceWater: null,
          terrains: ['desert', 'tundra', 'rainforests', 'mountains'],
        },
        {
          name: 'Tund',
          climates: ['unknown'],
          created: '2014-12-20T10:07:29.578000Z',
          diameter: 12190,
          edited: '2014-12-20T20:58:18.489000Z',
          gravity: 'unknown',
          id: 'cGxhbmV0czo0MQ==',
          orbitalPeriod: 1770,
          population: 0,
          rotationPeriod: 48,
          surfaceWater: null,
          terrains: ['barren', 'ash'],
        },
        {
          name: 'Haruun Kal',
          climates: ['temperate'],
          created: '2014-12-20T10:12:28.980000Z',
          diameter: 10120,
          edited: '2014-12-20T20:58:18.491000Z',
          gravity: '0.98',
          id: 'cGxhbmV0czo0Mg==',
          orbitalPeriod: 383,
          population: 705300,
          rotationPeriod: 25,
          surfaceWater: null,
          terrains: ['toxic cloudsea', 'plateaus', 'volcanoes'],
        },
        {
          name: 'Cerea',
          climates: ['temperate'],
          created: '2014-12-20T10:14:48.178000Z',
          diameter: null,
          edited: '2014-12-20T20:58:18.493000Z',
          gravity: '1',
          id: 'cGxhbmV0czo0Mw==',
          orbitalPeriod: 386,
          population: 450000000,
          rotationPeriod: 27,
          surfaceWater: 20,
          terrains: ['verdant'],
        },
        {
          name: 'Glee Anselm',
          climates: ['tropical', 'temperate'],
          created: '2014-12-20T10:18:26.110000Z',
          diameter: 15600,
          edited: '2014-12-20T20:58:18.495000Z',
          gravity: '1',
          id: 'cGxhbmV0czo0NA==',
          orbitalPeriod: 206,
          population: 500000000,
          rotationPeriod: 33,
          surfaceWater: 80,
          terrains: ['lakes', 'islands', 'swamps', 'seas'],
        },
        {
          name: 'Iridonia',
          climates: ['unknown'],
          created: '2014-12-20T10:26:05.788000Z',
          diameter: null,
          edited: '2014-12-20T20:58:18.497000Z',
          gravity: 'unknown',
          id: 'cGxhbmV0czo0NQ==',
          orbitalPeriod: 413,
          population: null,
          rotationPeriod: 29,
          surfaceWater: null,
          terrains: ['rocky canyons', 'acid pools'],
        },
        {
          name: 'Tholoth',
          climates: ['unknown'],
          created: '2014-12-20T10:28:31.117000Z',
          diameter: null,
          edited: '2014-12-20T20:58:18.498000Z',
          gravity: 'unknown',
          id: 'cGxhbmV0czo0Ng==',
          orbitalPeriod: null,
          population: null,
          rotationPeriod: null,
          surfaceWater: null,
          terrains: ['unknown'],
        },
        {
          name: 'Iktotch',
          climates: ['arid', 'rocky', 'windy'],
          created: '2014-12-20T10:31:32.413000Z',
          diameter: null,
          edited: '2014-12-20T20:58:18.500000Z',
          gravity: '1',
          id: 'cGxhbmV0czo0Nw==',
          orbitalPeriod: 481,
          population: null,
          rotationPeriod: 22,
          surfaceWater: null,
          terrains: ['rocky'],
        },
        {
          name: 'Quermia',
          climates: ['unknown'],
          created: '2014-12-20T10:34:08.249000Z',
          diameter: null,
          edited: '2014-12-20T20:58:18.502000Z',
          gravity: 'unknown',
          id: 'cGxhbmV0czo0OA==',
          orbitalPeriod: null,
          population: null,
          rotationPeriod: null,
          surfaceWater: null,
          terrains: ['unknown'],
        },
        {
          name: 'Dorin',
          climates: ['temperate'],
          created: '2014-12-20T10:48:36.141000Z',
          diameter: 13400,
          edited: '2014-12-20T20:58:18.504000Z',
          gravity: '1',
          id: 'cGxhbmV0czo0OQ==',
          orbitalPeriod: 409,
          population: null,
          rotationPeriod: 22,
          surfaceWater: null,
          terrains: ['unknown'],
        },
        {
          name: 'Champala',
          climates: ['temperate'],
          created: '2014-12-20T10:52:51.524000Z',
          diameter: null,
          edited: '2014-12-20T20:58:18.506000Z',
          gravity: '1',
          id: 'cGxhbmV0czo1MA==',
          orbitalPeriod: 318,
          population: 3500000000,
          rotationPeriod: 27,
          surfaceWater: null,
          terrains: ['oceans', 'rainforests', 'plateaus'],
        },
        {
          name: 'Mirial',
          climates: ['unknown'],
          created: '2014-12-20T16:44:46.318000Z',
          diameter: null,
          edited: '2014-12-20T20:58:18.508000Z',
          gravity: 'unknown',
          id: 'cGxhbmV0czo1MQ==',
          orbitalPeriod: null,
          population: null,
          rotationPeriod: null,
          surfaceWater: null,
          terrains: ['deserts'],
        },
        {
          name: 'Serenno',
          climates: ['unknown'],
          created: '2014-12-20T16:52:13.357000Z',
          diameter: null,
          edited: '2014-12-20T20:58:18.510000Z',
          gravity: 'unknown',
          id: 'cGxhbmV0czo1Mg==',
          orbitalPeriod: null,
          population: null,
          rotationPeriod: null,
          surfaceWater: null,
          terrains: ['rainforests', 'rivers', 'mountains'],
        },
        {
          name: 'Concord Dawn',
          climates: ['unknown'],
          created: '2014-12-20T16:54:39.909000Z',
          diameter: null,
          edited: '2014-12-20T20:58:18.512000Z',
          gravity: 'unknown',
          id: 'cGxhbmV0czo1Mw==',
          orbitalPeriod: null,
          population: null,
          rotationPeriod: null,
          surfaceWater: null,
          terrains: ['jungles', 'forests', 'deserts'],
        },
        {
          name: 'Zolan',
          climates: ['unknown'],
          created: '2014-12-20T16:56:37.250000Z',
          diameter: null,
          edited: '2014-12-20T20:58:18.514000Z',
          gravity: 'unknown',
          id: 'cGxhbmV0czo1NA==',
          orbitalPeriod: null,
          population: null,
          rotationPeriod: null,
          surfaceWater: null,
          terrains: ['unknown'],
        },
        {
          name: 'Ojom',
          climates: ['frigid'],
          created: '2014-12-20T17:27:41.286000Z',
          diameter: null,
          edited: '2014-12-20T20:58:18.516000Z',
          gravity: 'unknown',
          id: 'cGxhbmV0czo1NQ==',
          orbitalPeriod: null,
          population: 500000000,
          rotationPeriod: null,
          surfaceWater: 100,
          terrains: ['oceans', 'glaciers'],
        },
        {
          name: 'Skako',
          climates: ['temperate'],
          created: '2014-12-20T17:50:47.864000Z',
          diameter: null,
          edited: '2014-12-20T20:58:18.517000Z',
          gravity: '1',
          id: 'cGxhbmV0czo1Ng==',
          orbitalPeriod: 384,
          population: 500000000000,
          rotationPeriod: 27,
          surfaceWater: null,
          terrains: ['urban', 'vines'],
        },
        {
          name: 'Muunilinst',
          climates: ['temperate'],
          created: '2014-12-20T17:57:47.420000Z',
          diameter: 13800,
          edited: '2014-12-20T20:58:18.519000Z',
          gravity: '1',
          id: 'cGxhbmV0czo1Nw==',
          orbitalPeriod: 412,
          population: 5000000000,
          rotationPeriod: 28,
          surfaceWater: 25,
          terrains: ['plains', 'forests', 'hills', 'mountains'],
        },
        {
          name: 'Shili',
          climates: ['temperate'],
          created: '2014-12-20T18:43:14.049000Z',
          diameter: null,
          edited: '2014-12-20T20:58:18.521000Z',
          gravity: '1',
          id: 'cGxhbmV0czo1OA==',
          orbitalPeriod: null,
          population: null,
          rotationPeriod: null,
          surfaceWater: null,
          terrains: ['cities', 'savannahs', 'seas', 'plains'],
        },
        {
          name: 'Kalee',
          climates: ['arid', 'temperate', 'tropical'],
          created: '2014-12-20T19:43:51.278000Z',
          diameter: 13850,
          edited: '2014-12-20T20:58:18.523000Z',
          gravity: '1',
          id: 'cGxhbmV0czo1OQ==',
          orbitalPeriod: 378,
          population: 4000000000,
          rotationPeriod: 23,
          surfaceWater: null,
          terrains: ['rainforests', 'cliffs', 'canyons', 'seas'],
        },
        {
          name: 'Umbara',
          climates: ['unknown'],
          created: '2014-12-20T20:18:36.256000Z',
          diameter: null,
          edited: '2014-12-20T20:58:18.525000Z',
          gravity: 'unknown',
          id: 'cGxhbmV0czo2MA==',
          orbitalPeriod: null,
          population: null,
          rotationPeriod: null,
          surfaceWater: null,
          terrains: ['unknown'],
        },
      ],
      totalCount: 60,
    },
  },
};

describe('GraphQL Data Source', () => {
  let datasource: GraphQLDataSource;
  beforeEach(() => {
    TestBed.configureTestingModule({
      providers: [
        provideHttpClient(),
        NamedLoggingServiceFactory,
        HttpErrorObserverService,
        UrlHelperService,
        { provide: QUERYABLE_DATA_SOURCE_COUNT_SELECTOR, useValue: countSelector },
        { provide: QUERYABLE_DATA_SOURCE_DATA_SELECTOR, useValue: dataSelector },
        { provide: GRAPHQL_DATA_SOURCE_ENDPOINT, useValue: testEndpoint },
        { provide: GRAPHQL_DATA_SOURCE_TARGET, useValue: target },
        { provide: GRAPHQL_DATA_SOURCE_FIELDS, useValue: defaultFields },
        { provide: GRAPHQL_DATA_SOURCE_QUERY_BUILDER, useValue: queryBuilder },
        GraphQLDataSource,
      ],
      teardown: { destroyAfterEach: false },
    });
    datasource = TestBed.inject(GraphQLDataSource);
  });

  afterEach(() => datasource.disconnect());

  describe('no parameters', () => {
    it('should emit all items with no parameters set', (done) => {
      combineLatest([datasource.response$, datasource.data$]).subscribe({
        next: ([response, data]) => {
          expect(response).toEqual(expectedPlanetsResponse as any);
          expect(data).toEqual(dataSelector(expectedPlanetsResponse));
          done();
        },
        error: (err) => {
          expect(err).withContext('error').toBeNull();
          done();
        },
      });
    });
  });
});
